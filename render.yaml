services:
  # PostgreSQL Database
  - type: pserv
    name: db
    plan: free
    databaseName: ${DB_NAME}
    user: ${DB_USER}
    password: ${DB_PASSWORD}
    ipAllowList: [] # Allow all connections for simplicity, restrict in production

  # Backend Service
  - type: web
    name: backend
    plan: free
    buildCommand: "cd backend && pip install -r requirements.txt"
    startCommand: "cd backend && python -c 'from database import engine; from models import Base; Base.metadata.create_all(bind=engine)' && uvicorn main:app --host 0.0.0.0 --port 8000"
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: db
          property: connectionString
      - key: PAT_TOKEN
        sync: false # Mark as sensitive, will be set manually in Render dashboard
      - key: BOT_USER
        sync: false # Mark as sensitive
      - key: GEMINI_API_KEY
        sync: false # Mark as sensitive
    healthCheckPath: /
    autoDeploy: true
    
  # Frontend Service
  - type: web
    name: frontend
    plan: free
    buildCommand: "npm install && npm run build"
    startCommand: "npm run preview -- --host 0.0.0.0 --port 10000"
    envVars:
      - key: VITE_API_URL
        value: https://backend.onrender.com # Update with your actual backend URL
      - key: VITE_REPO_NAME
        sync: false # Mark as sensitive
    autoDeploy: true
    
  # Scheduler Service (for cron jobs)
  - type: worker
    name: scheduler
    plan: free
    buildCommand: "pip install -r backend/requirements.txt"
    startCommand: "/bin/sh -c \"apk add --no-cache dcron && (crontab -l 2>/dev/null; echo \\\"* * * * * python -u /app/scripts/autotrack.py 2>&1\\\" ) | crontab - && crond -f -d 8\""
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: db
          property: connectionString
      - key: PAT_TOKEN
        sync: false # Mark as sensitive
      - key: BOT_USER
        sync: false # Mark as sensitive
      - key: GEMINI_API_KEY
        sync: false # Mark as sensitive
    autoDeploy: true
